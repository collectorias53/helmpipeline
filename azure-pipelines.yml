trigger:
- master

pool:
  vmImage: ubuntu-latest

steps:
- task: Docker@2
  inputs:
    containerRegistry: 'ACR_ServiceConnection_1'
    repository: 'nodejsimage'
    command: 'buildAndPush'
    Dockerfile: '**/Dockerfile'

- task: HelmInstaller@1
  inputs:
    helmVersionToInstall: 'latest'

# Create the helmado1 directory
- script: mkdir -p /home/vsts/work/1/s/helmado1
  displayName: 'Create helmado1 directory'

- script: git clone https://github.com/collectorias53/helmpipeline /home/vsts/work/1/s/helmado1/
  displayName: 'Clone Helm chart repository into helmado1'

# List the contents of the helmado1 directory (optional for debugging)
- script: ls -la /home/vsts/work/1/s/helmado1
  displayName: 'List contents of helmado1 directory'

- task: HelmDeploy@1
  inputs:
    azureSubscriptionForACR: 'spconnection'
    azureResourceGroupForACR: 'rgterra'
    azureContainerRegistry: 'kubeacr1.azurecr.io'
    command: 'package'
    chartPath: '/home/vsts/work/1/s/helmado1'
    chartNameForACR: 'myapp-chart'
    chartPathForACR: '/home/vsts/work/1/s/helmado1'
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'drop'
    publishLocation: 'Container'
- task: HelmDeploy@1
  inputs:
    connectionType: 'Azure Resource Manager'
    azureSubscription: 'spconnection'
    azureResourceGroup: 'rgterra'
    kubernetesCluster: 'akstf'
    namespace: 'helmns'
    command: 'upgrade'
    chartType: 'FilePath'
    chartPath: '$(Build.ArtifactStagingDirectory)/drop'
